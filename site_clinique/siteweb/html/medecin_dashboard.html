<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord - Médecin</title>
  <link rel="stylesheet" href="../css/medecin_dashboard.css" />
</head>
<body>

  <header>
    <div class="logo-container">
      <img src="../image/logo.png" alt="Logo" class="logo" />
      <h1>Clinique VITALIS – Espace Médecin</h1>
    </div>
  </header>

  <nav class="tabs">
    <button onclick="showTab('rdv')">Rendez-vous</button>
    <button onclick="showTab('dispo')">Disponibilités</button>
    <button onclick="showTab('vacances')">Vacances</button>
  </nav>

  <main>
    
    <!-- Section Rendez-vous -->
<section id="rdv" class="tab-content">
  <h2>Mes rendez-vous de la semaine</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Heure</th>
        <th>Patient</th>
        <th>Service</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Les lignes seront insérées dynamiquement en JavaScript -->
    </tbody>
  </table>
</section>

    <!-- Section Dossier patient -->
    <section id="dossier" class="tab-content hidden">
      <h2>Dossier patient</h2>
      <p><strong>Nom :</strong> <span id="patient-nom">-</span></p>
      <p><strong>Date de naissance :</strong> <span id="patient-dob">-</span></p>
      <label for="note">Note de consultation :</label>
      <textarea id="note" placeholder="Écrire une note de consultation..."></textarea>
      <button id="enregistrer-note">Enregistrer</button>
    </section>


    <!-- Section Disponibilités -->
    <section id="dispo" class="tab-content hidden">
      <h2>Mes disponibilités</h2>
      <label for="jours">Jours :</label>
      <input type="text" id="jours" placeholder="Ex : Lundi, Mardi" />

      <label for="heures">Heures :</label>
      <input type="text" id="heures" placeholder="Ex : 9h - 16h" />

      <button>Soumettre</button>
    </section>

    <!-- Section Vacances -->
    <section id="vacances" class="tab-content hidden">
      <h2>Demande de vacances</h2>
      <label for="date-debut">Date de début :</label>
      <input type="date" id="date-debut" />

      <label for="date-fin">Date de fin :</label>
      <input type="date" id="date-fin" />

      <button>Envoyer la demande</button>
    </section>
  </main>

   <script src="../script/get_handle_data.js"></script>
  <script>
    const API_URL = 'http://localhost/api/';

    async function chargerAfficherRendezVous() {
        try {
            // 1. Charger les rendez-vous et patients
            const [rdvRes, patientsRes] = await Promise.all([
                fetch(`${API_URL}rendezvous`),
                fetch(`${API_URL}patients`)
            ]);

            // 2. Parser les réponses
            const listeRendezVous = await parseJsonSafe(rdvRes);
            const listePatients = await parseJsonSafe(patientsRes);

            // 3. Afficher les données
            const tbody = document.querySelector('#rdv tbody');
            tbody.innerHTML = listeRendezVous.map(rdv => {
                const patient = listePatients.find(p => p.COURRIEL === rdv.COURRIEL) || {};
                const nomService = rdv.service || "Inconnu";

                return `
                    <tr>
                        <td>${formatDate(rdv.DATE_RDV)}</td>
                        <td>${formatTime(rdv.HEURE)} (${rdv.DUREE} min)</td>
                        <td>${patient.PRENOM_PATIENT || 'Inconnu'} ${patient.NOM_PATIENT || ''} (${rdv.COURRIEL || 'Email manquant'})</td>
                        <td>${nomService}</td>
                        <td><button onclick="afficherDossier('${patient.PRENOM_PATIENT}', '${patient.NOM_PATIENT}', '${patient.DATE_NAISSANCE}')">Voir dossier</button></td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('Erreur:', error);
            document.querySelector('#rdv tbody').innerHTML = `
                <tr>
                    <td colspan="5" class="error">
                        Erreur de chargement: ${error.message}
                        <button onclick="chargerAfficherRendezVous()">Réessayer</button>
                    </td>
                </tr>
            `;
        }
    }

    // Fonctions utilitaires
    async function parseJsonSafe(response) {
        if (!response.ok) throw new Error(`Erreur ${response.status}`);
        const text = await response.text();
        return text ? JSON.parse(text) : [];
    }

    function formatTime(timeStr) {
        return timeStr?.substring(0, 5) || '--:--';
    }

    function formatDate(dateStr) {
        return dateStr?.trim().split(' ')[0] || 'Date invalide';
    }


    function afficherDossier(prenom, nom, dateNaissance) {
      // Affiche la section dossier si elle est masquée
  document.getElementById('dossier').classList.remove('hidden');

  // Insère les infos du patient dans le dossier
  document.getElementById('patient-nom').textContent = `${prenom} ${nom}`;
  document.getElementById('patient-dob').textContent = dateNaissance || 'Date inconnue';
}




    function showTab(id) {
      const sections = document.querySelectorAll('.tab-content');
      sections.forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    window.showTab = showTab; // rendre accessible aux attributs onclick



    document.addEventListener('DOMContentLoaded', chargerAfficherRendezVous,showTab);
</script>

</body>
</html>