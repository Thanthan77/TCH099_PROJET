<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de bord - Médecin</title>
  <link rel="stylesheet" href="../css/medecin_dashboard.css" />
</head>
<body>

  <header>
    <div class="logo-container">
      <img src="../image/logo.png" alt="Logo" class="logo" />
      <h1>Clinique VITALIS – Espace Médecin</h1>
    </div>
  </header>

  <nav class="tabs">
    <button onclick="showTab('rdv')">Rendez-vous</button>
    <button onclick="showTab('dispo')">Disponibilités</button>
    <button onclick="showTab('vacances')">Vacances</button>
  </nav>

  <main>
    
    <!-- Section Rendez-vous -->
<section id="rdv" class="tab-content">
  <h2>Mes rendez-vous de la semaine</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Heure</th>
        <th>Patient</th>
        <th>Service</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Les lignes seront insérées dynamiquement en JavaScript -->
    </tbody>
  </table>
</section>

    <!-- Section Dossier patient -->
    <section id="dossier" class="tab-content hidden">
      <h2>Dossier patient</h2>
      <p><strong>Nom :</strong> <span id="patient-nom">-</span></p>
      <p><strong>Date de naissance :</strong> <span id="patient-dob">-</span></p>
      <label for="note">Note de consultation :</label>
      <textarea id="note" placeholder="Écrire une note de consultation..."></textarea>
      <button id="enregistrer-note">Enregistrer</button>
    </section>


    <!-- Section Disponibilités -->
    <section id="dispo" class="tab-content hidden">
      <h2>Mes disponibilités</h2>
      <label for="jours">Jours :</label>
      <input type="text" id="jours" placeholder="Ex : Lundi, Mardi" />

      <label for="heures">Heures :</label>
      <input type="text" id="heures" placeholder="Ex : 9h - 16h" />

      <button>Soumettre</button>
    </section>

    <!-- Section Vacances -->
    <section id="vacances" class="tab-content hidden">
      <h2>Demande de vacances</h2>
      <label for="date-debut">Date de début :</label>
      <input type="date" id="date-debut" />

      <label for="date-fin">Date de fin :</label>
      <input type="date" id="date-fin" />

      <button>Envoyer la demande</button>
    </section>
  </main>

   <script src="../script/get_handle_data.js"></script>
  <script>
    const API_URL = 'http://localhost/api/';
    const codeEmploye = '100'; // À remplacer par le code dynamique si nécessaire

async function chargerAfficherRendezVous() {
    try {
        // 1. Charger les données
        const response = await fetch(`${API_URL}rendezvous/${codeEmploye}`);
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }

        const data = await response.json();
        console.log("Données reçues:", data); // Debug

        // 2. Charger les patients séparément
        const patientsRes = await fetch(`${API_URL}patients`);
        const listePatients = await patientsRes.json();

        // 3. Préparer la correspondance services
        const servicesMap = {};
        data.services.forEach(service => {
            servicesMap[service.id] = service.nom;
        });

        // 4. Afficher les données
        const tbody = document.querySelector('#rdv tbody');
        if (!tbody) {
            throw new Error("Élément #rdv tbody introuvable");
        }

        if (!data.rendezvous || data.rendezvous.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Aucun rendez-vous prévu</td></tr>';
            return;
        }

        tbody.innerHTML = data.rendezvous.map(rdv => {
            const patient = listePatients.find(p => p.COURRIEL === rdv.email) || {};
            const nomService = servicesMap[rdv.service_id] || "Service inconnu";

            return `
                <tr>
                    <td>${rdv.date}</td>
                    <td>${rdv.heure} (${rdv.duree} min)</td>
                    <td>${patient.PRENOM_PATIENT || 'Inconnu'} ${patient.NOM_PATIENT || ''}</td>
                    <td>${nomService}</td>
                    <td>
                        <button onclick="afficherDossier(
                            '${escapeHtml(patient.PRENOM_PATIENT || '')}',
                            '${escapeHtml(patient.NOM_PATIENT || '')}',
                            '${escapeHtml(patient.DATE_NAISSANCE || '')}'
                        )">Voir dossier</button>
                    </td>
                </tr>
            `;
        }).join('');

    } catch (error) {
        console.error('Erreur:', error);
        const errorHtml = `
            <tr>
                <td colspan="5" class="error">
                    Erreur de chargement: ${error.message}
                    <button onclick="chargerAfficherRendezVous()">Réessayer</button>
                </td>
            </tr>
        `;
        
        const tbody = document.querySelector('#rdv tbody');
        if (tbody) {
            tbody.innerHTML = errorHtml;
        } else {
            console.error("Impossible d'afficher l'erreur: tbody introuvable");
        }
    }
}

// Fonction d'échappement HTML
function escapeHtml(str) {
    if (!str) return '';
    return str.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function afficherDossier(prenom, nom, dateNaissance) {



      // Affiche la section dossier si elle est masquée


  document.getElementById('dossier').classList.remove('hidden');





  // Insère les infos du patient dans le dossier


  document.getElementById('patient-nom').textContent = `${prenom} ${nom}`;


  document.getElementById('patient-dob').textContent = dateNaissance || 'Date inconnue';


}



function showTab(id) {
      const sections = document.querySelectorAll('.tab-content');
      sections.forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    window.showTab = showTab; // rendre accessible aux attributs onclick

// Démarrer le chargement
document.addEventListener('DOMContentLoaded', chargerAfficherRendezVous,showTab);
</script>

</body>
</html>