<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de bord - Infirmière</title>
  <link rel="stylesheet" href="../css/infirmiere_dashboard.css">
  <script src="../script/infirmiere_dashboard.js" defer></script>
</head>
<body>

  <header>
    <div class="logo-container">
      <img src="../image/logo.png" alt="Logo" class="logo">
      <h1>Clinique VITALIS – Espace Infirmière</h1>
    </div>
  </header>

  <nav class="tabs">
    <button onclick="showTab('rdv')">Rendez-vous</button>
    <button onclick="showTab('horaire')">Horaires</button>
    <button onclick="showTab('vacances')">Vacances</button>
  </nav>

  <main>
    <!-- RDV -->
    <section id="rdv" class="tab-content">
      <h2>Mes rendez-vous de la semaine</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Heure</th><th>Patient</th><th>Service</th><th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>2025-07-15</td><td>08:30</td><td>Marc Lefebvre</td><td>Vaccin</td>
            <td><button onclick="showTab('dossier')">Voir dossier</button></td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Dossier patient -->
     <section id="dossier" class="tab-content hidden">
      <h2>Dossier patient</h2>
      <p><strong>Nom :</strong> <span id="patient-nom">-</span></p>
      <p><strong>Date de naissance :</strong> <span id="patient-dob">-</span></p>
      <p><strong>Numéro Assurance Maladie :</strong> <span id="patient-assm">-</span></p>
      <label for="note">Note de soin :</label>
      <textarea id="note" placeholder="Écrire une note de soin..."></textarea>
      <button id="enregistrer-note">Enregistrer</button>
    </section>


    <!-- Section Horaire -->
    <section id="horaire" class="tab-content hidden">
      <h2>Horaires</h2>
      <table>
        <thead>
          <tr>
            <th>Nom Employe</th>
            <th>Jours</th>
            <th>Heure</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>


    <!-- Vacances -->
    <section id="vacances" class="tab-content hidden">
      <h2>Demande de vacances</h2>
      <label for="date-debut">Date de début :</label>
      <input type="date" id="date-debut">

      <label for="date-fin">Date de fin :</label>
      <input type="date" id="date-fin">

      <button>Envoyer la demande</button>
    </section>
  </main>

  <script src="../script/get_handle_data.js"></script>
  <script>
  const API_URL = 'http://localhost/api/';
  const codeEmploye = new URLSearchParams(window.location.search).get("codeEmploye");

  async function chargerAfficherRendezVous() {
    try {
      if (!codeEmploye) {
        throw new Error("Code employé manquant dans l'URL");
      }

      // 1. Charger les rendez-vous de l'infirmière
      const response = await fetch(`${API_URL}rendezvous/${codeEmploye}`);
      if (!response.ok) {
        throw new Error(`Erreur HTTP: ${response.status}`);
      }
      const data = await response.json();

      // 2. Charger les patients
      const patientsRes = await fetch(`${API_URL}patients`);
      const listePatients = await patientsRes.json();

      // 3. Préparer les services
      const servicesMap = {};
      data.services.forEach(service => {
        servicesMap[service.id] = service.nom;
      });

      // 4. Affichage dans le tableau
      const tbody = document.querySelector('#rdv tbody');
      if (!tbody) throw new Error("Élément #rdv tbody introuvable");

      if (!data.rendezvous || data.rendezvous.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Aucun rendez-vous prévu</td></tr>';
        return;
      }

      tbody.innerHTML = data.rendezvous.map(rdv => {
        const patient = listePatients.find(p => p.COURRIEL === rdv.email) || {};
        const nomService = servicesMap[rdv.service_id] || "Service inconnu";

        return `
          <tr>
            <td>${rdv.date}</td>
            <td>${rdv.heure} (${rdv.duree} min)</td>
            <td>${patient.PRENOM_PATIENT || 'Inconnu'} ${patient.NOM_PATIENT || ''}</td>
            <td>${nomService}</td>
            <td>
              <button onclick="afficherDossier(
                '${escapeHtml(patient.PRENOM_PATIENT || '')}',
                '${escapeHtml(patient.NOM_PATIENT || '')}',
                '${escapeHtml(patient.DATE_NAISSANCE || '')}',
                '${escapeHtml(patient.NO_ASSURANCE_MALADIE || '')}'
              )">Voir dossier</button>
            </td>
          </tr>
        `;
      }).join('');

    } catch (error) {
      console.error('Erreur:', error);
      const errorHtml = `
        <tr>
          <td colspan="5" class="error">
            Erreur de chargement: ${error.message}
            <button onclick="chargerAfficherRendezVous()">Réessayer</button>
          </td>
        </tr>
      `;
      const tbody = document.querySelector('#rdv tbody');
      if (tbody) tbody.innerHTML = errorHtml;
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    return str.toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function afficherDossier(prenom, nom, dateNaissance, assurance) {
    document.getElementById('dossier').classList.remove('hidden');
    document.getElementById('patient-nom').textContent = `${prenom} ${nom}`;
    document.getElementById('patient-dob').textContent = dateNaissance || 'Date inconnue';
    document.getElementById('patient-assm').textContent = assurance || 'Assurance indisponible';

    // Réinitialiser champ texte et case à cocher
    document.getElementById('note-soin').value = '';
    document.getElementById('soin-complete').checked = false;
  }

    async function chargerAfficherHoraires() {
  try {
    const res = await fetch(`${API_URL}horaires`);
    const data = await res.json();

    const tbody = document.querySelector('#horaire table tbody');

    if (!Array.isArray(data) || !data.length) {
      tbody.innerHTML = '<tr><td colspan="3">Aucun horaire disponible</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(h => `
      <tr>
        <td>${escapeHtml(h.NOM_EMPLOYE)}</td>
        <td>${escapeHtml(h.JOURS)}</td>
        <td>${escapeHtml(h.HEURE)}</td>
      </tr>
    `).join('');

  } catch (error) {
    console.error("Erreur lors du chargement des horaires :", error);
    const tbody = document.querySelector('#horaire table tbody');
    tbody.innerHTML = '<tr><td colspan="3">Erreur de chargement des horaires</td></tr>';
  }
}


  function showTab(id) {
    const sections = document.querySelectorAll('.tab-content');
    sections.forEach(sec => sec.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  window.showTab = showTab;

  document.addEventListener('DOMContentLoaded', () => {
  chargerAfficherRendezVous();
  chargerAfficherHoraires();
});
</script>


</body>
</html>
